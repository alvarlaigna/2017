---
title: "Andmete kraapimine veebist"
output: 
  html_document:  
    theme: null
---

### Sissejuhatus

Eva "Usin" Masin on esimeses praktikumis kohatud Mati "Raha" Masina vastand. Talle meeldib rutiinsus, andmete tuim kopeerimine ja sisestamine. Vabal ajal meeldib talle lugeda romaanisarja "Tõde ja õigus" - eelmine nädal luges ta kokku tähekombinatsiooni "pa" esinemissageduse. Homme pärast tööd jätkab ta "pb" esinemissageduse leidmisega.

Õnneks oli eelnev tekst fiktsioon ja Eva-laadsed kopeerijad surid välja koos neandertaallastega. 
Selles praktikumis vaatame, kuidas R-is ellu äratada tehis-Eva, kes oskab veebilehtedelt automaatselt infot eraldada ja selle transformeerida struktureeritud andmestikuks. 

Täpsemalt, uurime

* kuidas eraldada Riigikogu hääletamistulemusi,
* kuidas eraldada Postimehe uudiste pealkirju,
* kuidas eraldada ilmajaama vaatlusandmeid. 

![](veebi_kraapimise_naide.png "Näide")

Kaks esimest ülesannet õpetavad paketi *rvest* funktsionaalsust ja annavad sissejuhatuse veebikraapimisse minimalistlike veebilehtede põhjal.

### Ülesanne 1 (2 punkti) - CSS id

Eralda [html koodis](../examples/html1.html) sinisena olev tekst muutujasse `tekst`. Kasuta paketti *rvest*. 

![](veebi_kraapimine_ex2.png "Näide")

* Vastava html koodiga saad mängida [siin](http://www.w3schools.com/html/tryit.asp?filename=tryhtml_css_id).

* Loe lühiülevaadet, millest koosnevad veebilehed ja uuri paketi *rvest* minimalistlikku näidet [siit](../praktikum5_rvest_minimal).

* Minimalistliku näite põhjal peaksid oskama eraldada lähtekoodis olevad 4 lõiku. Et eraldada lõik, kus id="p01", pead teadma, kuidas CSS-is tähistatakse id-sid.
Suur vihje on olemas eelneva html koodi < style > blokis. Abiks võib-olla ka [CSS selektorite interaktiivne testnäide](http://www.w3schools.com/cssref/trysel.asp).

* (**1 boonuspunkt**) CSS selektorite õppimiseks on tore tutorial http://flukeout.github.io/. Tee läbi esimesed 6 taset ja saada vastused tekstina.

* Uuri paketi [*rvest* dokumentatsiooni](http://cran.r-project.org/web/packages/rvest/rvest.pdf). Kasuks tulevad funktsioonid `read_html`, `html_node`, `html_nodes` ja `html_text`.

* Lõpptulemus peaks olema selline: `tekst = c("I am different.")`

```{r}
url = "http://andmeteadus.github.io/2017/examples/html1.html"

# sinu kood
```


<!--
```{r, eval=FALSE}
html_source = '<!DOCTYPE html>
<html>

<head>
<style>
p#p01 {
    color: blue;
}
</style>
</head>
<body>

<p>This is a paragraph.</p>
<p>This is a paragraph.</p>
<p>This is a paragraph.</p>
<p id="p01">I am different.</p>

</body>
</html>
'

# sinu kood

print(tekst)
```
-->

### Ülesanne 2 (2 punkti) - CSS class

Eralda [html koodis](../examples/html2.html) punaselt olev tekst muutujasse `tekst`. Kasuta paketti *rvest*. 

![](veebi_kraapimine_ex1.png "Näide")

* Vastava html koodiga saad mängida [siin](http://www.w3schools.com/html/tryit.asp?filename=tryhtml_css_class).

* Lõpptulemuse peaks olema selline: `tekst = c("I am different.", "I am different too.")`

```{r}
url = "http://andmeteadus.github.io/examples/html2.html"

# sinu kood
```


<!--
```{r, eval=FALSE}
html_source = '<!DOCTYPE html>
<html>

<head>
<style>
p.error {
    color:red;
}
</style>
</head>
<body>

<p>This is a paragraph.</p>
<p>This is a paragraph.</p>
<p class="error">I am different.</p>
<p>This is a paragraph.</p>
<p class="error">I am different too.</p>

</body>
</html>'

# sinu kood

print(tekst)
```
-->

### Ülesanne 3 (2 punkti)

Eralda Riigikogu hääletamistulemuste  [veebilehelt](https://www.riigikogu.ee/tegevus/tooulevaade/haaletused/haaletustulemused-kohalolekukontroll/b3d7e354-3656-477a-8482-fbdd2ddbe64c/) (lähtekoodi nägemiseks paremklikk ja Wiew Page Source), mitu saadikut hääletas "kobarseaduse":

* poolt
* vastu
* oli erapooletu
* ei hääletanud

> Praktikumis tutvusime, kuidas brauseri veebiarenduse tööriistadega leida üles lähtekoodist vajalikud kohad. Variandid olid: 
> 
> * Chrome'is vajuta parem klikk ja "inspekteeri elementi". Alernatiivid on klahvikombinatsioon Ctrl + Shift + I või klahv F12. 
> * vahendiga [selectorgadget](http://selectorgadget.com/)
> 
> Need muudavad lähtekoodis õige klassi, id või sildi leidmise oluliselt lihtsamaks. Mõnes olukorras on kasulikum üks variant, mõnes teine. 

Vihjed:

* Väärtuste eraldamiseks kasuta atribuuti *href*. Uuri, kuidas eraldada atribuute CSS-i õppimise *tutorialist* http://flukeout.github.io/ (alates levelist 27).

* Kasutada paketi *readr* funktsiooni `parse_number()` kui sa ei taha regulaaravaldistega mässata. Vaata näiteks, mida teeb järgmine koodirida `"Kokku: 101 liiget" %>% parse_number()`

```{r}
url = "https://www.riigikogu.ee/tegevus/tooulevaade/haaletused/haaletustulemused-kohalolekukontroll/b3d7e354-3656-477a-8482-fbdd2ddbe64c/"

# sinu kood

```


### Ülesanne 4 (2 punkti)

Eralda "kobarseaduse" hääletamistulemuste andmetabel, kus on 101 rida ja tunnused *Nimi*, *Otsus* ja *Fraktsioon*.

Vihjed: 

* kasuta funktsiooni `html_table`,
* tabelis veeru *Otsus* puhastamiseks saab kasutada näiteks paketi *stringr* funktsioone `str_sub()` ja `str_locate()` (viimasega otsida näiteks topelt tühikute asukohta). 


```{r}
 # sinu kood
  
```

### Ülesanne 5 (1 punkt)

Visualiseeri, kuidas jaotusid otsused fraktsioonide lõikes.

```{r}
 # sinu kood
  
```


<!--

### Ülesanne 5 (5 punkti) - andmestiku ehitamine

Ülesandes 4 tegid läbi Riigikogu saadikute hääletamistulemuste eraldamise kooseluseaduse korral. Failis [htmls.zip](../data/htmls.zip) on olemas veebilehed kõigi Riigikogu XII hääletuste kohta. Sinu ülesandeks on koostada andmetabel, kus ridades on Riigikogu saadiku nimi ja veergudes kõik hääletamiskorrad. Seda andmestikku läheb vaja järgmises praktikumis, kus uurime hääletamismustreid.

1. Kõigepealt paki lahti zip fail ja loe R-i sisse kõigi html failide nimed.  
Näpunäide: Järgnev kood aitab kätte saada kõigi antud kaustas olevad csv-failide nimed (seejuures argument `full.names` võimaldab tagastada terve failitee).

```{r, eval=FALSE}
filenames = list.files("C:/Users/Kasutaja/andmeteadus/kodutoo5/", pattern = "*.csv", full.names=TRUE)
```

2. Esialgu loe sisse umbes 5 erinevat html faili.  

* NB! Alles siis, kui oled täiesti kindel, et sinu kood töötab korrektselt, võta kasutusele kõik html failid.
* Näpunäide: Järgnev kood loeb sisse kõik muutujas `filenames` olevad `csv` andmestikud ja tekitab neist listi. 

```{r, eval=FALSE}
list_of_dataframes = list()
for(i in 1:length(filenames)){
  temp = read.csv(filenames[i])
  list_of_dataframes[[i]] = temp
}
```

* Praegu pole sul `read.csv` käsuga midagi peale hakata, sest tegeleme html failidega. Kasuta ülesandes 4 kirjutatud funktsiooni `extract_table`.
* Eelneva `for`-tsükli asemel võid kasutada funktsiooni `lapply`. 

3. Lisa igal tsükli sammul andmestikule hääletuse indeks või muu identifikaator. Näiteks `temp$haaletus = i`. 

4. Nüüdseks peaksid olema saanud listi, mille elementideks on erinevad andmetabelid (kõiki faile kasutades peaks nende koguarv olema 1845). Tee nendest andmetabelitest üks suur (pikk) andmetabel, paigutades need üksteise otsa. Seda aitab teha paketi dplyr funktsioon `rbind_all`. Tulemuseks peaksid saama andmetabeli, mille ridade arv on 101 * "sinu kasutatud failide arv". 

5. Muuda pikk andmetabel laiaks. Seda aitab teha paketi reshape2 käsk `dcast`. Uuri funktsiooni `dcast` minimalistlikku näidet [siit](../praktikum3_reshape/#dcast).

6. Kui kõik eelnev töötab, tee eelnev läbi kõikide html failidega. Ära kohku, kui kõikide html tabelite eraldamisega läheb aega 5 minutit või rohkem. 

7. Soovitus: Kui oled eelneva ühe korra läbi teinud, pole vaja knitri raporti genereerimisel enam sedasama korrata. Saadud andmetabeli saad endale salvestada käsuga `save(andmed, file="riigikogu.RData")`. Raportis võid muuta vastava koodiploki `eval=FALSE`. 



```{r}
# sinu kood
```

Lõpptulemuseks võiksid saada järgneva andmestiku, kus on 143 rida ning 1846 veergu. 


|Nimi         |1     |2     |3     |4     |...   |1844   |1845   |
|:------------|:-----|:-----|:-----|:-----|:-----|:------|:------|
|Aadu Must    |vastu |poolt |vastu |poolt |... |NA     |NA     |
|Aare Heinvee |poolt |poolt |poolt |poolt |... |poolt  |poolt  |
|Aivar Kokk   |poolt |poolt |poolt |poolt |... |puudub |puudub |

-->


### Ülesanne 6 (3 punkti)

> Eva "Usin" Masin töötab start-upis, mis lubab Eesti turule tuua unikaalse personaalse uudisterakenduse, mis filtreerib uudiseid vastavalt kasutaja soovidele. Eva "Usin" Masin pandi koostama andmebaasi Postimehe esilehe uudiste kohta. Eva teab, kuidas karjääriredelis ülespoole ronida: "Bossi käsu peale olgu uudiste pealkirjad võimalikult kiiresti olemas".

Automatiseeri seesama protsess. Tagasta kõik Postimehe esilehe uudiste pealkirjad (joonisel näidatud kollasega). 

* Ära kurvasta, kui sa ei saa absoluutselt kõiki pealkirju, 97% on praegu piisav.
* Kui sulle ei meeldi Postimehe veebilehe hiiglaslikku lähtekoodi inspekteerida brauseris vaikimisi olevate vahenditega, siis abiks on praktikumis tutvustatud tööriist [selectorgadget](http://selectorgadget.com/).
* Vaata, et sinu tagastatud pealkirjade hulgas poleks tühju sõnesid või arve.

![](postimees_example.png "Näide")

```{r}
url = "http://www.postimees.ee/"

# sinu kood
```

### Ülesanne 7 (3 punkti)

> Eva "Usin" Masinal on suur huvi ilmaandmete vastu. Kümme minutit pärast iga täistundi märgib ta Ilmateenistuse vaatlusandmeid oma märkmikku, et hiljem analüüsi teha.

Automatiseeri seesama protsess. 

Juhised:

* Riigi Ilmateenistus pakub värskeid [ilmaandmeid XML faili kujul](http://www.ilmateenistus.ee/teenused/ilmainfo/eesti-vaatlusandmed-xml/).
* Meie tegeleme [Eesti vaatlusandmete XML failiga](http://www.ilmateenistus.ee/ilma_andmed/xml/observations.php).
* Saa XML failist kätte iga ilmajaama õhurõhk.
* Saa XML failist kätte iga ilmajaama tuule kiirus.
* Tee neist õhurõhu ja tuule kiiruse *scatterplot*.

Näpunäide:

* Uuri paketi [*rvest* minimalistlikku näidet info eraldamisest XML failist](../praktikum5_rvest_minimal/#xml).


### Ülesanne 8 (2 punkti)

> Eva "Usin" Masin on lotohuviline, aga ta pole aastaid Viking Lottoga võitnud. Ta arvab, et lototulemused pole päris juhuslikud ning lotos on võimalik statistiline eelis saada.
Seepärast märgib ta iga lotokolmapäev Viking Lotto loositud numbrid üles ja uurib, kas number kahtesid loositakse rohkem välja, kui juhus lubaks.

1.) Õpeta tehis-Eva tegema seda sama.

* Eesti Loto veebilehel on toodud [statistika loositud pallide sagedusest](https://www.eestiloto.ee/osi/stats.do?lastDraws=250&gameCode=11&sort=frq0&action=searchNumbers).
* Eralda vastav tabel, kus veergudes on tunnused *Number*, *Sagedus* ja *Sagedus protsentides*.
* selectorgadget veab sind siin alt ning kergem on lähtekoodi inspekteerida brauseris olevate tööriistadega (Chrome's vajuta `Ctrl + Shift + I` või tee parem klikk ja vajuta inspekteeri elementi).
* Visualiseeri saadud andmetabelit. Tee näiteks tulpdiagramm, kus x-teljel on arvud 1-48 ning y-telg tähistab sagedust.

2.) (**2 boonuspunkti + lisaboonuspunkt**) Viimase 250 loosiga on pall 35 tulnud 31 korral, pall 43 aga 61 korral. Uuri, kas on alust arvata, et Viking Lotto süsteem on kallutatud. Selleks mõtle välja, kuidas seda kontrollida (näiteks võid kasutada simulatsioonidel põhinevat lähenemist). Selgita lühidalt oma lähenemist ja raporteeri, millise tulemuse said. Lisaboonuspunkti saamiseks visualiseeri seda tulemust.


### Boonusülesanne 1 (kuni 5 punkti) - Kas kõik teed viivad Facebooki? (ehk juhuslik ekslemine veebilehtedel)

Alusta suvaliselt veebilehelt. Eralda kõik väljuvad lingid. Vali üks neist linkidest suvaliselt. Hüppa sellele lingile. Kui sellel leheküljel pole ühtegi väljuvat linki, mine tagasi. Kui väljuvaid linke on mitmeid, vali jälle välja suvaline ja hüppa sinna. Kui jõudsid Facebooki, on katse lõppenud. Korda seda protsessi mitu korda ja erinevate alglehtedega. Uuri, mitmel juhul jõudsid FBsse.

Näpunäide: Abiks on paketi rvest funktsioon `follow_link()`. 

### Boonusülesanne 2 - Facebooki API kasutamine

Kasuta paketti *Rfacebook* ning leia:

**(1 boonuspunkt)** Mis on olnud Tartu Ülikooli Facebooki lehe kõige populaarsem postitus? Mis on olnud matemaatika ja statistika intituudi Facebooki lehe kõige populaarsem postitus?

**(5 boonuspunkti :-))** Kasuta R-i, et uuendada oma staatust tekstiga 'Teen aine "Statistiline andmeteadus ja visualiseerimine" kodutööd. Väga põnev! :-)'. Abiks on käsk `updateStatus`.

<!--
**(3 boonuspunkti)** Kui sulle ei meeldi Facebooki algoritm, mille põhjal ta postitusi ja pilte uudisvoos järjestab, mõtle välja algoritm, mis selle parandab. Implementeeri selle prototüüp (kasuks tuleb käsk `getNewsfeed`).
--->

Abistavad lingid:

* Kuidas autentida: http://thinktostart.com/analyzing-facebook-with-r/
* Rfacebook dokumentatsioon: http://cran.r-project.org/web/packages/Rfacebook/Rfacebook.pdf